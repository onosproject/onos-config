# Extending onos-config with Model Plugins

onos-config is an extensible configuration management system, that allows the
configuration of many different types and versions of devices to be managed
concurrently.

Information models in YANG format (RFC 6020) can be used to accurately define
the configuration and state objects and attributes of a device. In practice a
device's object model usually comprises of a number of YANG files including
augments and deviations, and must be considered as a combined unit.

In **onos-config** a set of these combined YANG files defining a particular
version of a device type is known as a **model**.

Over its lifecycle onos-config will have to deal with many different models as
its scope is expanded and as devices go through new release cycles. To allow
this models are loadable dynamically as plugins in the form of Linux or Mac
shared object libraries **(\*.so)** using the YGOT library and are know as
**Model Plugins**.

The diagram shows the connection between the Model Plugin and the configuration
store - linked by Device Type and Version. Effectively the primary key
of the Model Registry is the Model Name and Version, whereas the primary key of
the Configuration is the Device Name and Version. 

![onos-config internals](images/onos-config-internals.png)

## Structure of a Model Plugin
A Model Plugin is mainly generated by the generator command from the YGOT
project, and a wrapper **modelmain.go** implementing the ModelPlugin interface.
They are compiled together with the **go build** command using the
**-buildmode=plugin** option. 

Many examples of Model Plugins are in the [modelplugin](../modelplugin)
folder of this project, and an example script
[ModelGenerator.sh](../modelplugin/ModelGenerator.sh) is available for creating
new plugins.

### ModelPlugin Interface
The model plugin must implement the **ModelPlugin** interface. This will allow
it to be entered in to the Model Registry.
```go
type ModelPlugin interface {
	ModelData() (string, string, []*gnmi.ModelData, string)
	UnmarshalConfigValues(jsonTree []byte) (*ygot.ValidatedGoStruct, error)
	Validate(*ygot.ValidatedGoStruct, ...ygot.ValidationOption) error
	Schema() (map[string]*yang.Entry, error)
}
``` 

### Create your own Model Plugin using script
1) Change directory in to onos-config/modelplugins
1) Copy ModelGenerator.sh to a new file
1) Edit the variables at the top of the file to suit your plugin (see
**modelmain.go Definitions** below for specifics), taking special care that the
entries in MODELDATA and YANGLIST match each other and are in alphabetical order
1) Make sure the required Yang files are present in the **./yang** folder and named properly
1) Run the script like
```bash
> ./ModelGenerator.sh
```

Once the files are created:
1) Change directory back to **onos-config**
2) Compile the plugin with (replacing the names as appropriate)
```bash
> GO111MODULE=on CGO_ENABLED=1 go build -o modelplugin/TestDevice-1.0.0/testdevice.so.1.0.0 -buildmode=plugin -tags=modelplugin ./modelplugin/TestDevice-1.0.0
```
Follow the steps in **Loading the Model Plugin** below for how to load it.

## YANG files
The YANG files to be used with generator.go should be collected together in a
folder and named in the style: **\<modulename>@\<latestrevision>.yang**

Running the generator command in the form:
```bash
go run $GOPATH/src/github.com/openconfig/ygot/generator/generator.go \
-path yang -output_file=$TYPEVERSION/$TYPEVERSIONPKG/generated.go -package_name=$TYPEVERSIONPKG \
-generate_fakeroot $YANGLIST
```
will check all nested dependencies are present, **and** that the output is
generated as a single file: **generated.go**.
> Where $YANGLIST is a space separated list of YANG file names.
> See ModelGenerator.sh for an example

To visualize and further validate the collection of YANG files, the
**[pyang](https://github.com/mbj4668/pyang)** tool can be used like:
```bash
pyang -f tree $YANGLIST
```
> Once the generator has run there is no need to persist the YANG files - the
> generated.go file contains all the information in an object model.


## modelmain.go definitions
> Examples of these definitions are given in [ModelGenerator.sh](../modelplugins/ModelGenerator.sh)

### modeltype
This should be a name that defines the type of device, but should not include
version. This name will be used later in the **Configuration** of the device.
It should be between 4 and 40 chars and only include alphanumeric characters,
dash, underscore and colon.

### modelversion
This should be the version number of the device in [Semantic Versioning](https://semver.org/)
form. Only numeric characters and '.' character are allowed.

### modulename
This should be the same as the filename given to the Model Plugin when compiled.
It comprises
* the modeltype (converted to lower case),
* concatenated with '.so.' and
* the version.

e.g. devicesim.so.1.0.0 

### modeldata
The primary YANG files of the device should be listed in the ModelData section
of the **modelmain.go** file. These are the YANG files that define the top level
containers and lists. During compilation other YANG files may get pulled in
because they define reusable types (but should not be listed in model data).

Each entry in modeldata should be in the format of
* name - the name of the **module** inside the YANG file
* version - the value of the **latest** revision inside the YANG file in the
format YYYY-MM-DD
* organization - the value from the **organization** field of the YANG file

> There should be no duplicate entries (of name) in the list and the list should be ordered alphabetically.

# Loading the Model Plugin
The Model Plugin can be loaded at the start up of onos-config by specifying the
-modelPlugin argument (see [run.md](./run.md)), or it can be loaded dynamically
at runtime using the [CLI](./cli.md) command:
```
onos models load <full path and filename to plugin file on the system where onos-config runs>
```

> Model Plugins cannot be unloaded once loaded, without restarting onos-config.

To see a list of loaded plugins use the command:
```bash
onos models list
```
which gives an output like:
```bash
> onos models list
TestDevice: 1.0.0 from testdevice.so.1.0.0 containing
YANGS:
	test1	2018-02-20	Open Networking Foundation
Containers & Lists:
	Device
	Test1_Cont1A
	Test1_Cont1A_Cont2A
	Test1_Cont1A_List2A
	Test1_Cont1BState
	Test1_Cont1BState_List2B

TestDevice: 2.0.0 from testdevice.so.2.0.0 containing
YANGS:
	test1	2019-06-10	Open Networking Foundation
Containers & Lists:
	Test1_Cont1A_Cont2A
	Test1_Cont1BState
	Test1_Cont1BState_Cont2C
	Test1_Cont1BState_List2B
	Device
	Test1_Cont1A
	Test1_Cont1A_List2A
```

>In a distributed installation the ModelPlugin will have to be loaded
>on all running instances of onos-config.

# Model Plugins and gNMI Capabilities
## Capabilities on gNMI Northbound interface
The CapabilitiesResponse on the gNMI northound interface is generated dynamically
from the **modeldata** section of all of the loaded Model Plugins.

## Capabilities comparison on Southbound gNMI interface
At runtime when devices are connected to onos-config the response to the
Capabilities request are compared with the
modeldata for their corresponding ModelPlugin - if there is not an exact
match a warning is displayed.

# OpenConfig Models
Some devices that support OpenConfig Models report their capabilities using an
OpenConfig versioning scheme e.g. 0.5.0, rather than the YANG revision date in
the format 2017-07-06. If the device can correct its capabilities to give the
revision then it should to be more consistent with non OpenConfig YANG models.

Accessing OpenConfig model of a specific revision requires a number of steps in
[Github](https://github.com/openconfig/public).

For instance if a device reports it used openconfig-interfacess.yang **2.0.0**,
then to get this file do:
* Browse to [openconfig-interfaces.yang](https://github.com/openconfig/public/blob/master/release/models/interfaces/openconfig-interfaces.yang)
* Observe in the list of **revision** items in the YANG file that the reference
**2.0.0** corresponds to a release date of **2017-07-14**
* Click in the **History** button
* In the **History** page for this file, see that the next commit after this
date was on **Aug 9, 2017**
* Click on the related **commit message**
* In the list of files modified in that commit click the **...** next to the file
**openconfig-interfacess.yang** and choose **View File**
* In the page that displays the historical version of the file, click the **Raw** button
* In the resulting raw display of the YANG file verify that the latest revision is **2017-07-14**
* Save the file locally as **openconfig-interfaces@2017-07-14.yang**

All the files in the [yang](../modelplugin/yang) folder were downloaded in this
way. They are not strictly needed once **generated.go** has been created, but are
kept here for convenience, saving to have to run the procedure above if a change
was needed.

> If the generator program reports that a dependency was required e.g.
**openconfig-inet-types.yang** then the version of this file with a date equal
to or before 2017-07-14 should be downloaded - it is **openconfig-inet-types@2017-07-14.yang**
